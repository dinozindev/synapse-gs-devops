trigger:
  branches:
    exclude:
      - "*"

pr:
  branches:
    include:
      - main  # Build só via PR

variables:
  - group: SynapseSecrets  # contém: PG_HOST, PG_DB, PG_USER, PG_PASS, JWT_SECRET

  # Variáveis não sensíveis
  - name: rgName
    value: 'rg-api-synapse'
  - name: webAppName
    value: 'webapp-synapse01'
  - name: location
    value: 'brazilsouth'
  - name: projectPath
    value: 'GlobalSolution2/GlobalSolution2.csproj'
  - name: testProjectPath
    value: 'GlobalSolution2.Tests/GlobalSolution2.Tests.csproj'

stages:

# ==========================================================
# STAGE 1: BUILD
# ==========================================================
- stage: Build
  displayName: "Build Stage"
  jobs:
    - job: BuildJob
      displayName: "Build .NET 9 Project"
      pool:
        vmImage: 'ubuntu-latest'
      steps:

        # Checkout código
        - checkout: self

        # Setup .NET 9
        - task: UseDotNet@2
          displayName: 'Install .NET 9 SDK'
          inputs:
            packageType: 'sdk'
            version: '9.0.x'

        # Restaurar dependências
        - task: DotNetCoreCLI@2
          displayName: 'Restore Dependencies'
          inputs:
            command: 'restore'
            projects: '$(projectPath)'

        # Build
        - task: DotNetCoreCLI@2
          displayName: 'Build Project'
          inputs:
            command: 'build'
            projects: '$(projectPath)'
            arguments: '--configuration Release --no-restore'

        # Executar testes
        - task: DotNetCoreCLI@2
          displayName: 'Run Unit Tests'
          inputs:
            command: 'test'
            projects: '$(testProjectPath)'
            arguments: '--configuration Release --logger "trx;LogFileName=test_results.trx"'

        # Publicar resultados de teste
        - task: PublishTestResults@2
          displayName: 'Publish Test Results'
          condition: always()
          inputs:
            testResultsFormat: 'VSTest'
            testResultsFiles: '**/*.trx'
            testRunTitle: 'Unit Tests - Synapse API'
            mergeTestResults: true

        # Publicar cobertura
        - task: PublishCodeCoverageResults@1
          displayName: 'Publish Code Coverage'
          condition: always()
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(Agent.TempDirectory)/**/coverage.cobertura.xml'

        # Instalar EF Core Tools (necessário para rodar migrations)
        - task: DotNetCoreCLI@2
          displayName: 'Install EF Core Tools'
          inputs:
            command: 'custom'
            custom: 'tool'
            arguments: 'install --global dotnet-ef --version 9.0.0'

        # Aplicar EF Core Migrations
        - task: DotNetCoreCLI@2
          displayName: 'Apply EF Core Migrations'
          inputs:
            command: 'custom'
            custom: 'ef'
            arguments: 'database update --project $(projectPath) --connection "Host=$(PG_HOST);Database=$(PG_DB);Username=$(PG_USER);Password=$(PG_PASS);SSL Mode=Require;Trust Server Certificate=true"'

        # Publicar aplicação
        - task: DotNetCoreCLI@2
          displayName: 'Publish Application'
          inputs:
            command: 'publish'
            publishWebProjects: false
            projects: '$(projectPath)'
            arguments: '--configuration Release --output $(Build.ArtifactStagingDirectory) --no-build'
            zipAfterPublish: true

        # Publicar artefato
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Build Artifact'
          inputs:
            pathToPublish: '$(Build.ArtifactStagingDirectory)'
            artifactName: 'webapp'
            publishLocation: 'Container'

# ==========================================================
# STAGE 2: DEPLOY
# ==========================================================
- stage: Release
  displayName: "Deploy to Azure"
  dependsOn: Build
  condition: succeeded()
  jobs:
    - deployment: DeployWebApp
      displayName: "Deploy to Azure Web App"
      environment: 'Production'
      pool:
        vmImage: 'ubuntu-latest'
      strategy:
        runOnce:
          deploy:
            steps:

            # Download do artefato
            - download: current
              artifact: webapp

            # Deploy no Azure Web App
            - task: AzureWebApp@1
              displayName: 'Deploy to Azure Web App'
              inputs:
                azureSubscription: 'conn-azure-synapse'
                appType: 'webAppLinux'
                appName: '$(webAppName)'
                package: '$(Pipeline.Workspace)/webapp/**/*.zip'
                runtimeStack: 'DOTNETCORE|9.0'

            # Configurar App Settings com variáveis secretas
            - task: AzureAppServiceSettings@1
              displayName: 'Configure App Settings'
              inputs:
                azureSubscription: 'conn-azure-synapse'
                appName: '$(webAppName)'
                resourceGroupName: '$(rgName)'
                appSettings: |
                  [
                    {"name":"ASPNETCORE_ENVIRONMENT","value":"Production","slotSetting":false},
                    {"name":"ConnectionStrings__PostgreConnection","value":"Host=$(PG_HOST);Database=$(PG_DB);Username=$(PG_USER);Password=$(PG_PASS);SSL Mode=Require;Trust Server Certificate=true","slotSetting":false},
                    {"name":"JwtSettings__Secret","value":"$(JWT_SECRET)","slotSetting":false},
                    {"name":"JwtSettings__Issuer","value":"SynapseAPI","slotSetting":false},
                    {"name":"JwtSettings__Audience","value":"SynapseUsers","slotSetting":false},
                    {"name":"JwtSettings__ExpirationMinutes","value":"60","slotSetting":false},
                    {"name":"WEBSITES_PORT","value":"8080","slotSetting":false}
                  ]

